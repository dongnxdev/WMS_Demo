@model WMS_Demo.ViewModels.ReceiptCreateViewModel

@{
    ViewData["Title"] = "Tạo Phiếu Nhập Kho";
}

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<h2>Tạo Phiếu Nhập Kho</h2>

<form asp-action="CreateInbound" method="post" id="form-create">
    <div class="row">
        <div class="col-md-4">
            <div class="form-group mb-3">
                <label asp-for="Date" class="control-label"></label>
                <input asp-for="Date" class="form-control" />
                <span asp-validation-for="Date" class="text-danger"></span>
            </div>
        </div>
        <div class="col-md-4">
            <div class="form-group mb-3">
                <label asp-for="PartnerId" class="control-label"></label>
                <select asp-for="PartnerId" class="form-control select2-supplier"></select>
                <span asp-validation-for="PartnerId" class="text-danger"></span>
                
                <input type="hidden" asp-for="PartnerName" id="hdnPartnerName" />
            </div>
        </div>
        <div class="col-md-12">
            <div class="form-group mb-3">
                <label asp-for="Notes" class="control-label"></label>
                <textarea asp-for="Notes" class="form-control"></textarea>
            </div>
        </div>
    </div>

    <hr />
    <h4>Chi tiết hàng hóa</h4>
    
    <table class="table table-bordered" id="tbl-details">
        <thead>
            <tr>
                <th width="35%">Sản phẩm</th>
                <th width="20%">Vị trí</th>
                <th width="10%">Đơn vị</th>
                <th width="10%">Số lượng</th>
                <th width="15%">Đơn giá</th>
                <th width="10%">Xóa</th>
            </tr>
        </thead>
        <tbody id="details-body">
            @for (int i = 0; i < Model.Details.Count; i++)
            {
                // Render lại dữ liệu nếu Form bị lỗi (Re-index fix)
                <tr>
                    <td>
                        <select name="Details[@i].ItemId" class="form-control select2-item" data-index="@i">
                            <option value="@Model.Details[i].ItemId" selected>@Model.Details[i].ItemName</option>
                        </select>
                        <input type="hidden" name="Details[@i].ItemName" value="@Model.Details[i].ItemName" />
                    </td>
                    <td>
                        <select name="Details[@i].LocationId" class="form-control select2-location">
                             <option value="@Model.Details[i].LocationId" selected>@Model.Details[i].LocationCode</option>
                        </select>
                        <input type="hidden" name="Details[@i].LocationCode" value="@Model.Details[i].LocationCode" />
                    </td>
                    <td><input type="text" class="form-control" name="Details[@i].Unit" value="@Model.Details[i].Unit" readonly /></td>
                    <td>
                        <input type="number" class="form-control" name="Details[@i].Quantity" value="@Model.Details[i].Quantity" />
                        <span class="text-danger field-validation-valid" data-valmsg-for="Details[@i].Quantity"></span>
                    </td>
                    <td>
                        <input type="number" class="form-control" name="Details[@i].Price" value="@Model.Details[i].Price" min="0" />
                    </td>
                    <td><button type="button" class="btn btn-danger btn-sm btn-remove-row">Xóa</button></td>
                </tr>
            }
        </tbody>
    </table>

    <button type="button" class="btn btn-success mb-3" id="btn-add-row">
        <i class="bi bi-plus-circle"></i> Thêm dòng
    </button>

    <div class="form-group">
        <button type="submit" class="btn btn-primary btn-lg">Lưu phiếu nhập</button>
        <a asp-action="InboundIndex" class="btn btn-secondary btn-lg">Hủy</a>
    </div>
</form>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}

    <script>
        $(document).ready(function () {
            // Biến để lưu trữ dữ liệu tải trước
            let initialItemsData = [];
            let initialLocationsData = [];

            // 1. Cấu hình Select2 cho Nhà cung cấp
            // Tải dữ liệu nhà cung cấp ngay khi trang được load
            $.ajax({
                url: '@Url.Action("SearchSuppliers", "Warehouse")',
                dataType: 'json'
            }).done(function (initialData) {
                $('.select2-supplier').select2({
                    placeholder: "Tìm kiếm nhà cung cấp...",
                    allowClear: true,
                    data: initialData, // Sử dụng dữ liệu đã tải
                    // AJAX vẫn được giữ lại để tìm kiếm khi người dùng gõ
                    ajax: {
                        url: '@Url.Action("SearchSuppliers", "Warehouse")',
                        dataType: 'json',
                        delay: 250,
                        data: function (params) { return { term: params.term }; },
                        processResults: function (data) { return { results: data }; }
                    }
                });

                // Nếu là re-render (khi lỗi), set lại giá trị text cho select2
                var initialPartnerId = '@Model.PartnerId';
                var initialPartnerName = '@Html.Raw(Model.PartnerName)';
                if (initialPartnerId && initialPartnerId != "0") {
                    var option = new Option(initialPartnerName, initialPartnerId, true, true);
                    $('.select2-supplier').append(option).trigger('change');
                }
            });

            // Tải trước dữ liệu cho Items và Locations một lần duy nhất
            const loadMasterData = $.when(
                $.ajax({ url: '@Url.Action("SearchItems", "Warehouse")', dataType: 'json' }),
                $.ajax({ url: '@Url.Action("SearchLocations", "Warehouse")', dataType: 'json' })
            );

            loadMasterData.done(function (itemsResponse, locationsResponse) {
                initialItemsData = itemsResponse[0];
                initialLocationsData = locationsResponse[0];
                // Sau khi tải xong, khởi tạo select2 cho các dòng đã có (nếu có)
                $('#details-body tr').each(function () {
                    initRowSelect2($(this));
                });
            });

            // Cập nhật tên vào hidden field khi chọn
            $('.select2-supplier').on('select2:select', function (e) {
                $('#hdnPartnerName').val(e.params.data.text);
            });

            // 2. Hàm khởi tạo Select2 cho Item và Location trong bảng
            function initRowSelect2(row) {
                // Item Select2
                row.find('.select2-item').select2({
                    placeholder: "Chọn vật tư...",
                    data: initialItemsData, // Sử dụng dữ liệu đã tải trước
                    // AJAX vẫn được giữ lại để tìm kiếm khi người dùng gõ
                    ajax: {
                        url: '@Url.Action("SearchItems", "Warehouse")',
                        dataType: 'json',
                        delay: 250,
                        data: function (params) { return { term: params.term }; },
                        // processResults không cần thiết khi có ajax và data
                        processResults: function (data) { return { results: data }; }
                    }
                }).on('select2:select', function (e) {
                    // Tự động điền đơn vị tính
                    var data = e.params.data;
                    var tr = $(this).closest('tr');
                    tr.find('input[name$=".Unit"]').val(data.unit);
                    tr.find('input[name$=".ItemName"]').val(data.text); // Lưu tên
                });

                // Location Select2
                row.find('.select2-location').select2({
                    placeholder: "Vị trí...",
                    data: initialLocationsData, // Sử dụng dữ liệu đã tải trước
                     // AJAX vẫn được giữ lại để tìm kiếm khi người dùng gõ
                    ajax: {
                        url: '@Url.Action("SearchLocations", "Warehouse")',
                        dataType: 'json',
                        delay: 250,
                        data: function (params) { return { term: params.term }; },
                        processResults: function (data) { return { results: data }; }
                    }
                }).on('select2:select', function (e) {
                     var tr = $(this).closest('tr');
                     tr.find('input[name$=".LocationCode"]').val(e.params.data.text);
                });
            }

            // 3. Xử lý nút "Thêm dòng"
            $('#btn-add-row').click(function () {
                var index = $('#details-body tr').length;
                var html = `
                    <tr>
                        <td>
                            <select name="Details[${index}].ItemId" class="form-control select2-item"></select>
                            <input type="hidden" name="Details[${index}].ItemName" />
                        </td>
                        <td>
                            <select name="Details[${index}].LocationId" class="form-control select2-location"></select>
                             <input type="hidden" name="Details[${index}].LocationCode" />
                        </td>
                        <td><input type="text" class="form-control" name="Details[${index}].Unit" readonly /></td>
                        <td><input type="number" class="form-control" name="Details[${index}].Quantity" value="1" min="0.01" step="0.01" /></td>
                        <td><input type="number" class="form-control" name="Details[${index}].Price" value="0" min="0" /></td>
                        <td><button type="button" class="btn btn-danger btn-sm btn-remove-row">Xóa</button></td>
                    </tr>
                `;
                var newRow = $(html);
                $('#details-body').append(newRow);
                initRowSelect2(newRow);
            });

            // 4. Xử lý xóa dòng
            $(document).on('click', '.btn-remove-row', function () {
                $(this).closest('tr').remove();
                updateIndices();
            });

            function updateIndices() {
                $('#details-body tr').each(function (index, tr) {
                    $(tr).find('select, input').each(function () {
                        var name = $(this).attr('name');
                        if (name) {
                            $(this).attr('name', name.replace(/\[\d+\]/, '[' + index + ']'));
                        }
                    });
                });
            }
        });
    </script>
}