@model WMS_Demo.ViewModels.ReceiptCreateViewModel

@{
    ViewData["Title"] = "Tạo Phiếu Xuất Kho";
}

@* --- CSS CHO SELECT2 & GIAO DIỆN --- *@
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />

<style>
    .select2-container--bootstrap-5 .select2-selection {
        border-color: #dee2e6;
    }
    .table-input {
        min-width: 100px;
    }
    /* Tô đỏ input nếu có lỗi */
    .input-error {
        border-color: #dc3545 !important;
        background-color: #fff8f8;
    }
</style>

<div class="card shadow-sm">
    <div class="card-header bg-primary text-white">
        <h4 class="mb-0"><i class="bi bi-box-arrow-right"></i> Tạo Phiếu Xuất Kho</h4>
    </div>
    <div class="card-body">
        <form asp-action="CreateOutbound" method="post" id="createOutboundForm">
            @Html.AntiForgeryToken()
            
            @* --- THÔNG TIN CHUNG (HEADER) --- *@
            <div class="row mb-4">
                @* <div class="col-md-4">
                    <div class="form-group mb-3">
                        <label asp-for="Date" class="control-label fw-bold">Ngày Xuất</label>
                        <input asp-for="Date" class="form-control" type="datetime-local" value="@DateTime.Now.ToString("yyyy-MM-ddTHH:mm")" />
                        <span asp-validation-for="Date" class="text-danger"></span>
                    </div>
                </div> *@
                <div class="col-md-4">
                    <div class="form-group mb-3">
                        <label asp-for="PartnerId" class="control-label fw-bold">Khách Hàng</label>
                        <select asp-for="PartnerId" class="form-control" id="PartnerId"></select>
                        <span asp-validation-for="PartnerId" class="text-danger"></span>
                    </div>
                </div>
                <div class="col-md-12">
                    <div class="form-group mb-3">
                        <label asp-for="Notes" class="control-label fw-bold">Ghi Chú</label>
                        <textarea asp-for="Notes" class="form-control" placeholder="Nhập ghi chú xuất kho..."></textarea>
                        <span asp-validation-for="Notes" class="text-danger"></span>
                    </div>
                </div>
            </div>

            @* --- CHI TIẾT SẢN PHẨM (DETAILS) --- *@
            <h5 class="mb-3 border-bottom pb-2">Danh sách hàng hóa</h5>
            <div class="table-responsive">
                <table class="table table-bordered table-hover align-middle" id="detailsTable">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 30%">Sản phẩm</th>
                            <th style="width: 10%">ĐVT</th>
                            <th style="width: 15%">Vị trí (Location)</th>
                            <th style="width: 15%">Số lượng</th>
                            <th style="width: 15%">Đơn giá bán</th>
                            <th style="width: 15%" class="text-center">Tương tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        @* Dữ liệu sẽ được render bằng JS hoặc giữ lại nếu Model invalid *@
                        @if (Model.Details != null && Model.Details.Count > 0)
                        {
                            for (int i = 0; i < Model.Details.Count; i++)
                            {
                                <tr>
                                    <td>
                                        <select name="Details[@i].ItemId" class="form-control item-select" data-selected-id="@Model.Details[i].ItemId" data-selected-text="@Model.Details[i].ItemName">
                                            @if (Model.Details[i].ItemId != 0)
                                            {
                                                <option value="@Model.Details[i].ItemId" selected>@Model.Details[i].ItemName</option>
                                            }
                                        </select>
                                    </td>
                                    <td>
                                        <input type="text" class="form-control unit-display bg-light" readonly value="@Model.Details[i].Unit" />
                                    </td>
                                    <td>
                                        <select name="Details[@i].LocationId" class="form-control location-select" data-selected-id="@Model.Details[i].LocationId">
                                            @* Sẽ load lại bằng JS sau *@
                                        </select>
                                    </td>
                                    <td>
                                        <input type="number" name="Details[@i].Quantity" class="form-control quantity-input" value="@Model.Details[i].Quantity" min="0.01" step="0.01" />
                                    </td>
                                    <td>
                                        <input type="number" name="Details[@i].Price" class="form-control price-input" value="@Model.Details[i].Price" />
                                    </td>
                                    <td class="text-center">
                                        <button type="button" class="btn btn-sm btn-outline-danger remove-row"><i class="bi bi-trash"></i>Xóa</button>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>

            <div class="mb-4">
                <button type="button" id="addDetail" class="btn btn-success">
                    <i class="bi bi-plus-circle"></i> Thêm dòng
                </button>
            </div>

            @* --- ACTION BUTTONS --- *@
            <div class="d-flex justify-content-end gap-2">
                <a asp-action="OutboundIndex" class="btn btn-secondary">Quay lại</a>
                <button type="submit" class="btn btn-primary px-4 fw-bold">Lưu Phiếu Xuất</button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    @* --- SCRIPT LIBRARY --- *@
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
        $(document).ready(function () {
            // Cấu hình mặc định cho Select2 theme Bootstrap 5
            $.fn.select2.defaults.set( "theme", "bootstrap-5" );

            // --- 1. KHỞI TẠO TÌM KIẾM KHÁCH HÀNG ---
            $('#PartnerId').select2({
                ajax: {
                    url: '@Url.Action("SearchCustomers", "Warehouse")',
                    dataType: 'json',
                    delay: 250,
                    data: function (params) { return { term: params.term }; },
                    processResults: function (data) { return { results: data }; }
                },
                placeholder: 'Tìm kiếm khách hàng...',
                allowClear: true
            });

            // Nếu model trả về có PartnerId (khi validate lỗi), ta cần set lại giá trị text
            // (Phần này anh cần truyền PartnerName từ Controller xuống nếu muốn hiển thị lại tên đẹp)
            var initialPartnerId = '@Model.PartnerId';
            if (initialPartnerId && initialPartnerId != '0') {
                 // Nếu có tên thì append option, ở đây demo set value thôi
                 // Tốt nhất ViewModel nên có PartnerName để hiển thị lại
            }


            // --- 2. HÀM KHỞI TẠO SELECT2 CHO MỘT DÒNG ---
            function initRowPlugins($tr) {
                // A. Select2 Sản Phẩm
                var $itemSelect = $tr.find('.item-select');
                
                $itemSelect.select2({
                    ajax: {
                        url: '@Url.Action("SearchItems", "Warehouse")',
                        dataType: 'json',
                        delay: 250,
                        data: function (params) { return { term: params.term }; },
                        processResults: function (data) { return { results: data }; }
                    },
                    placeholder: 'Chọn sản phẩm',
                    minimumInputLength: 0
                });

                // B. Select2 Vị Trí (Khởi tạo rỗng)
                var $locSelect = $tr.find('.location-select');
                $locSelect.select2({
                    placeholder: 'Chọn sản phẩm trước',
                    data: []
                }).prop('disabled', true);

                // --- LOGIC: NẾU ĐÂY LÀ DÒNG CŨ (RE-RENDER KHI LỖI) ---
                // Kiểm tra xem có data-selected-id không để load lại thông tin
                var selectedItemId = $itemSelect.data('selected-id');
                var selectedLocId = $locSelect.data('selected-id');

                if (selectedItemId && selectedItemId != 0) {
                     // Trigger change để load location
                     // Lưu ý: Cần fetch lại Location list cho Item này
                     loadLocations($tr, selectedItemId, selectedLocId);
                }
            }

            // --- 3. SỰ KIỆN KHI CHỌN SẢN PHẨM ---
            $('#detailsTable').on('select2:select', '.item-select', function (e) {
                var data = e.params.data; // {id, text, unit, price...}
                var $tr = $(this).closest('tr');

                // Điền thông tin phụ
                $tr.find('.unit-display').val(data.unit || '');
                $tr.find('.price-input').val(data.price || 0);

                // Load danh sách vị trí
                loadLocations($tr, data.id, null);
            });

            // --- 4. HÀM LOAD LOCATION TỪ SERVER ---
            function loadLocations($tr, itemId, preSelectedLocId) {
                var $locSelect = $tr.find('.location-select');
                
                // Clear cũ
                $locSelect.empty().trigger('change');
                $locSelect.prop('disabled', true); 

                $.ajax({
                    url: '@Url.Action("GetLocationsForItem", "Warehouse")',
                    data: { itemId: itemId },
                    success: function (data) {
                        // data = [{id, text, stock}, ...]
                        
                        if (!data || data.length === 0) {
                            var opt = new Option("Hết hàng (Stock: 0)", "", true, true);
                            $locSelect.append(opt).trigger('change');
                        } else {
                            $locSelect.append(new Option("Chọn kệ hàng...", "", true, true)); // Placeholder

                            data.forEach(function (item) {
                                // item.text đã được format ở Controller: "Code (Sẵn: 10)"
                                var option = new Option(item.text, item.id, false, false);
                                // Gán stock vào attribute để validate
                                $(option).attr('data-max', item.stock);
                                $locSelect.append(option);
                            });
                            
                            $locSelect.prop('disabled', false);

                            // Nếu có giá trị cũ (khi edit/lỗi) thì chọn lại
                            if (preSelectedLocId) {
                                $locSelect.val(preSelectedLocId).trigger('change');
                            }
                        }
                    },
                    error: function() {
                        alert("Lỗi khi tải danh sách vị trí!");
                    }
                });
            }

            // --- 5. VALIDATION: CHECK SỐ LƯỢNG TỒN (Client Side) ---
            $('#detailsTable').on('change keyup', '.quantity-input, .location-select', function () {
                var $tr = $(this).closest('tr');
                var $locSelect = $tr.find('.location-select');
                var $qtyInput = $tr.find('.quantity-input');

                // Lấy option đang chọn
                // Lưu ý: Select2 lấy data khác select thường một chút, ta dùng jQuery find option:selected
                var selectedOption = $locSelect.find('option:selected');
                var maxStock = parseFloat(selectedOption.attr('data-max')) || 0;
                var currentQty = parseFloat($qtyInput.val()) || 0;

                // Nếu đã chọn vị trí và số lượng > tồn
                if ($locSelect.val() && currentQty > maxStock) {
                    $qtyInput.addClass('input-error');
                    // Có thể thêm tooltip hoặc text cảnh báo
                    $qtyInput.attr('title', 'Vượt quá tồn kho: ' + maxStock);
                } else {
                    $qtyInput.removeClass('input-error');
                    $qtyInput.removeAttr('title');
                }
            });

            // --- 6. THÊM DÒNG MỚI ---
            $('#addDetail').click(function () {
                var index = $('#detailsTable tbody tr').length;
                
                var template = `
                    <tr>
                        <td>
                            <select name="Details[${index}].ItemId" class="form-control item-select" required></select>
                        </td>
                        <td>
                            <input type="text" class="form-control unit-display bg-light" readonly />
                        </td>
                        <td>
                            <select name="Details[${index}].LocationId" class="form-control location-select" required></select>
                        </td>
                        <td>
                            <input type="number" name="Details[${index}].Quantity" class="form-control quantity-input" min="0.01" step="0.01" required />
                        </td>
                        <td>
                            <input type="number" name="Details[${index}].Price" class="form-control price-input" required />
                        </td>
                        <td class="text-center">
                            <button type="button" class="btn btn-sm btn-outline-danger remove-row"><i class="bi bi-trash"></i>Xóa</button>
                        </td>
                    </tr>
                `;
                
                var $newRow = $(template);
                $('#detailsTable tbody').append($newRow);
                initRowPlugins($newRow);
            });

            // --- 7. XÓA DÒNG & ĐÁNH LẠI INDEX ---
            // (Rất quan trọng để Model Binding không bị null List)
            $('#detailsTable').on('click', '.remove-row', function () {
                $(this).closest('tr').remove();
                reIndexTable();
            });

            function reIndexTable() {
                $('#detailsTable tbody tr').each(function (index, row) {
                    var $row = $(row);
                    // Cập nhật name cho các input
                    $row.find('select, input').each(function () {
                        var name = $(this).attr('name');
                        if (name) {
                            // Thay thế Details[oldIndex] -> Details[newIndex]
                            var newName = name.replace(/Details\[\d+\]/, 'Details[' + index + ']');
                            $(this).attr('name', newName);
                        }
                    });
                });
            }

            // Init cho các dòng có sẵn (nếu có)
            $('#detailsTable tbody tr').each(function() {
                initRowPlugins($(this));
            });
        });
    </script>
}