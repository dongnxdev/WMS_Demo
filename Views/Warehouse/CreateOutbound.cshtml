@model WMS_Demo.ViewModels.ReceiptCreateViewModel

@{
    ViewData["Title"] = "Tạo Phiếu Xuất Kho";
}

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="fw-bold text-uppercase text-dark mb-0">Tạo Phiếu Xuất Kho</h2>
        <span class="text-muted small">Điền thông tin và chi tiết hàng hóa cần xuất</span>
    </div>
    <a asp-action="OutboundIndex" class="btn btn-secondary btn-industrial">
        <i class="fa-solid fa-arrow-left me-1"></i> Quay lại
    </a>
</div>


<div class="card card-industrial">
    <div class="card-body">
        <form asp-action="CreateOutbound" method="post" id="form-create">
            <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>
             @if (TempData["Error"] != null)
            {
                <div class="alert alert-danger">@TempData["Error"]</div>
            }
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group mb-3">
                        <label asp-for="Date" class="control-label fw-bold">Ngày xuất</label>
                        <input asp-for="Date" class="form-control" />
                        <span asp-validation-for="Date" class="text-danger"></span>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group mb-3">
                        <label asp-for="PartnerId" class="control-label fw-bold">Khách hàng</label>
                        <select asp-for="PartnerId" class="form-control select2-customer"></select>
                        <span asp-validation-for="PartnerId" class="text-danger"></span>
                        
                        <input type="hidden" asp-for="PartnerName" id="hdnPartnerName" />
                    </div>
                </div>
                <div class="col-md-12">
                    <div class="form-group mb-3">
                        <label asp-for="Notes" class="control-label fw-bold">Ghi chú</label>
                        <textarea asp-for="Notes" class="form-control"></textarea>
                    </div>
                </div>
            </div>

            <hr />
            <h4 class="mb-3">Chi tiết hàng hóa xuất</h4>
            
            <table class="table table-bordered" id="tbl-details">
                <thead class="bg-light">
                    <tr>
                        <th width="35%">Sản phẩm (chỉ hiện SP có tồn kho)</th>
                        <th width="20%">Vị trí</th>
                        <th width="10%">Đơn vị</th>
                        <th width="15%">Đơn giá xuất</th>
                        <th width="15%">Số lượng xuất</th>
                        <th width="5%">Xóa</th>
                    </tr>
                </thead>
                <tbody id="details-body">
                    @for (int i = 0; i < Model.Details.Count; i++)
                    {
                        <tr>
                            <td>
                                <select name="Details[@i].ItemId" class="form-control select2-item" data-index="@i">
                                    <option value="@Model.Details[i].ItemId" selected>@Model.Details[i].ItemName</option>
                                </select>
                                <input type="hidden" name="Details[@i].ItemName" value="@Model.Details[i].ItemName" />
                            </td>
                            <td>
                                <select name="Details[@i].LocationId" class="form-control select2-location">
                                     <option value="@Model.Details[i].LocationId" selected>@Model.Details[i].LocationCode</option>
                                </select>
                                <input type="hidden" name="Details[@i].LocationCode" value="@Model.Details[i].LocationCode" />
                            </td>
                            <td><input type="text" class="form-control" name="Details[@i].Unit" value="@Model.Details[i].Unit" readonly /></td>
                            <td>
                                <input type="number" class="form-control" name="Details[@i].Price" value="@Model.Details[i].Price" min="0" />
                            </td>
                            <td>
                                <input type="number" class="form-control" name="Details[@i].Quantity" value="@Model.Details[i].Quantity" />
                                <span class="text-danger field-validation-valid" data-valmsg-for="Details[@i].Quantity"></span>
                            </td>
                            <td><button type="button" class="btn btn-danger btn-sm btn-remove-row"><i class="fa-solid fa-trash"></i></button></td>
                        </tr>
                    }
                </tbody>
            </table>

            <button type="button" class="btn btn-success mb-3" id="btn-add-row">
                <i class="fa-solid fa-plus me-1"></i> Thêm hàng hóa
            </button>

            <div class="form-group mt-4">
                <button type="submit" class="btn btn-primary btn-lg btn-industrial">
                    <i class="fa-solid fa-save me-1"></i> Lưu phiếu xuất
                </button>
            </div>
        </form>
    </div>
</div>


@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}

    <script>
        $(document).ready(function () {
            let initialItemsData = [];
            let initialLocationsData = [];

            // 1. Cấu hình Select2 cho Khách hàng
            $('.select2-customer').select2({
                placeholder: "Tìm kiếm khách hàng...",
                allowClear: true,
                ajax: {
                    url: '@Url.Action("SearchCustomers", "Warehouse")',
                    dataType: 'json',
                    delay: 250,
                    data: function (params) { return { term: params.term }; },
                    processResults: function (data) { return { results: data }; }
                }
            });

            // Nếu là re-render (khi lỗi), set lại giá trị text cho select2
            var initialPartnerId = '@Model.PartnerId';
            var initialPartnerName = '@Html.Raw(Model.PartnerName)';
            if (initialPartnerId && initialPartnerId != "0") {
                var option = new Option(initialPartnerName, initialPartnerId, true, true);
                $('.select2-customer').append(option).trigger('change');
            }

            $('.select2-customer').on('select2:select', function (e) {
                $('#hdnPartnerName').val(e.params.data.text);
            });
            
            // Tải trước dữ liệu cho Items và Locations
            const loadMasterData = $.when(
                $.ajax({ url: '@Url.Action("SearchItems", "Warehouse")', dataType: 'json' }),
                $.ajax({ url: '@Url.Action("SearchLocations", "Warehouse")', dataType: 'json' })
            );

            loadMasterData.done(function (itemsResponse, locationsResponse) {
                initialItemsData = itemsResponse[0];
                initialLocationsData = locationsResponse[0];
                $('#details-body tr').each(function () {
                    initRowSelect2($(this));
                });
            });

            // 2. Hàm khởi tạo Select2 cho Item và Location
            function initRowSelect2(row) {
                row.find('.select2-item').select2({
                    placeholder: "Chọn vật tư...",
                    data: initialItemsData,
                    ajax: {
                        url: '@Url.Action("SearchItems", "Warehouse")',
                        dataType: 'json',
                        delay: 250,
                        data: function (params) { return { term: params.term }; },
                        processResults: function (data) { 
                             // Chỉ trả về các item có tồn kho > 0
                             var filteredData = data.filter(function(item) {
                                var stockMatch = item.text.match(/Tồn: ([\d.]+)/);
                                return stockMatch && parseFloat(stockMatch[1]) > 0;
                            });
                            return { results: filteredData };
                         }
                    }
                }).on('select2:select', function (e) {
                    var data = e.params.data;
                    var tr = $(this).closest('tr');
                    tr.find('input[name$=".Unit"]').val(data.unit);
                    tr.find('input[name$=".ItemName"]').val(data.text);
                });

                row.find('.select2-location').select2({
                    placeholder: "Vị trí...",
                    data: initialLocationsData,
                    ajax: {
                        url: '@Url.Action("SearchLocations", "Warehouse")',
                        dataType: 'json',
                        delay: 250,
                        data: function (params) { return { term: params.term }; },
                        processResults: function (data) { return { results: data }; }
                    }
                }).on('select2:select', function (e) {
                     var tr = $(this).closest('tr');
                     tr.find('input[name$=".LocationCode"]').val(e.params.data.text);
                });
            }

            // 3. Thêm dòng mới
            $('#btn-add-row').click(function () {
                var index = $('#details-body tr').length;
                var html = `
                    <tr>
                        <td>
                            <select name="Details[${index}].ItemId" class="form-control select2-item"></select>
                            <input type="hidden" name="Details[${index}].ItemName" />
                        </td>
                        <td>
                            <select name="Details[${index}].LocationId" class="form-control select2-location"></select>
                             <input type="hidden" name="Details[${index}].LocationCode" />
                        </td>
                        <td><input type="text" class="form-control" name="Details[${index}].Unit" readonly /></td>
                        <td><input type="number" class="form-control" name="Details[${index}].Price" value="0" min="0" /></td>
                        <td><input type="number" class="form-control" name="Details[${index}].Quantity" value="1" min="0.01" step="0.01" /></td>
                        <td><button type="button" class="btn btn-danger btn-sm btn-remove-row"><i class="fa-solid fa-trash"></i></button></td>
                    </tr>
                `;
                var newRow = $(html);
                $('#details-body').append(newRow);
                initRowSelect2(newRow);
            });

            // 4. Xóa dòng
            $(document).on('click', '.btn-remove-row', function () {
                $(this).closest('tr').remove();
                updateIndices();
            });

            // 5. Cập nhật lại index khi xóa
            function updateIndices() {
                $('#details-body tr').each(function (index, tr) {
                    $(tr).find('select, input').each(function () {
                        var name = $(this).attr('name');
                        if (name) {
                            $(this).attr('name', name.replace(/\[\d+\]/, '[' + index + ']'));
                        }
                    });
                });
            }
        });
    </script>
}
